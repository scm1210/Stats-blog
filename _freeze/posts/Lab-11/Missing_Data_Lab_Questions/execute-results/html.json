{
  "hash": "d0d04e4183791b85e53714ee85149037",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Missings Data Lab\"\nsubtitle: \"Princeton University\"\nauthor: \"Steven Mesquiti\"\noutput: \n  tufte::tufte_html:\n    css: \n    tufte_variant: \"envisioned\"\n    highlight: github-dark\n    fig_height: 10\n    fig_width: 16\n    toc: true\n    toc_depth: 1\nexecute: \n  message: false\n  warning: false\nformat: html\nengine: knitr\ncategories: [Lab, code, analysis, Missing Data]\n---\n\n\n\nMissing data is a common problem and dealing with it appropriately is extremely important. Ignoring the missing data points or filling them incorrectly may cause the models to work in unexpected ways and cause the predictions and inferences to be biased.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pacman)\npacman::p_load(tidyverse,mice,naniar,devtools,patchwork,gghalves,skimr,install = T)\n\n#### define plot objects and stuff\n\npalette <- c(\n  \"#772e25\", \"#c44536\", \"#ee9b00\", \"#197278\", \"#283d3b\", \n  \"#9CC5A1\", \"#6195C6\", \"#ADA7C9\", \"#4D4861\", \"grey50\",\n  \"#d4a373\", \"#8a5a44\", \"#4a6a74\", \"#5c80a8\", \"#a9c5a0\",\n  \"#7b9b8e\", \"#e1b16a\", \"#a69b7c\", \"#9d94c4\", \"#665c54\"\n)\n\npalette_condition = c(\"#ee9b00\", \"#c44536\",\"#005f73\", \"#283d3b\", \"#9CC5A1\", \"#6195C6\", \"#ADA7C9\", \"#4D4861\")\n\nplot_aes = theme_minimal() +\n  theme(\n    legend.position = \"top\",\n    legend.text = element_text(size = 12),\n    text = element_text(size = 16, family = \"Futura Medium\"),\n    axis.text = element_text(color = \"black\"),\n    axis.ticks.y = element_blank(),\n    plot.title = element_text(size = 20, hjust = 0.5) # Adjusted title size and centering\n  )\n```\n:::\n\n\n\nLe'ts consider built-in dataset 'airquality' in R as a sample dataset.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the airquality dataset\ndata(\"airquality\")\n\ndata <- airquality\n\ndata |> \n  head() |> \n  DT::datatable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-6a5c219d30a6e9703e44\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-6a5c219d30a6e9703e44\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\"],[41,36,12,18,null,28],[190,118,149,313,null,null],[7.4,8,12.6,11.5,14.3,14.9],[67,72,74,62,56,66],[5,5,5,5,5,5],[1,2,3,4,5,6]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Ozone<\\/th>\\n      <th>Solar.R<\\/th>\\n      <th>Wind<\\/th>\\n      <th>Temp<\\/th>\\n      <th>Month<\\/th>\\n      <th>Day<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5,6]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"Ozone\",\"targets\":1},{\"name\":\"Solar.R\",\"targets\":2},{\"name\":\"Wind\",\"targets\":3},{\"name\":\"Temp\",\"targets\":4},{\"name\":\"Month\",\"targets\":5},{\"name\":\"Day\",\"targets\":6}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n#### Question 1:\n\n(a) Examine this dataset for missing values. While there are many ways to do this, the skim function from the library 'skimr' is elegant;\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata |> \n  skim() |> \n  DT::datatable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-7e5b3bceec2e130f72b4\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7e5b3bceec2e130f72b4\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\"],[\"numeric\",\"numeric\",\"numeric\",\"numeric\",\"numeric\",\"numeric\"],[\"Ozone\",\"Solar.R\",\"Wind\",\"Temp\",\"Month\",\"Day\"],[37,7,0,0,0,0],[0.7581699346405228,0.9542483660130719,1,1,1,1],[42.12931034482759,185.9315068493151,9.957516339869281,77.88235294117646,6.993464052287582,15.80392156862745],[32.98788451443394,90.05842222838166,3.523001352212594,9.465269740971454,1.416522484012314,8.864520368425419],[1,7,1.7,56,5,1],[18,115.75,7.4,72,6,8],[31.5,205,9.699999999999999,79,7,16],[63.25,258.75,11.5,85,8,23],[168,334,20.7,97,9,31],[\"▇▃▂▁▁\",\"▅▃▅▇▅\",\"▂▇▇▃▁\",\"▂▃▇▇▃\",\"▇▇▇▇▇\",\"▇▇▇▇▆\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>skim_type<\\/th>\\n      <th>skim_variable<\\/th>\\n      <th>n_missing<\\/th>\\n      <th>complete_rate<\\/th>\\n      <th>numeric.mean<\\/th>\\n      <th>numeric.sd<\\/th>\\n      <th>numeric.p0<\\/th>\\n      <th>numeric.p25<\\/th>\\n      <th>numeric.p50<\\/th>\\n      <th>numeric.p75<\\/th>\\n      <th>numeric.p100<\\/th>\\n      <th>numeric.hist<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[3,4,5,6,7,8,9,10,11]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"skim_type\",\"targets\":1},{\"name\":\"skim_variable\",\"targets\":2},{\"name\":\"n_missing\",\"targets\":3},{\"name\":\"complete_rate\",\"targets\":4},{\"name\":\"numeric.mean\",\"targets\":5},{\"name\":\"numeric.sd\",\"targets\":6},{\"name\":\"numeric.p0\",\"targets\":7},{\"name\":\"numeric.p25\",\"targets\":8},{\"name\":\"numeric.p50\",\"targets\":9},{\"name\":\"numeric.p75\",\"targets\":10},{\"name\":\"numeric.p100\",\"targets\":11},{\"name\":\"numeric.hist\",\"targets\":12}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n(b) use the nanair package to visualize missing values\n\n\n\n::: {.cell align='center'}\n\n```{.r .cell-code}\ndata |> \ngg_miss_var(show_pct = TRUE) +\n  labs(title = \"Missing Data by Variable in our dataset\") + \n  scale_fill_manual(values = palette) +\n  plot_aes\n```\n\n::: {.cell-output-display}\n![](Missing_data_lab/fig_unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n(c) even though it's hard to confirm based on visualizations alone, what do your visualizations lead you to believe about the missing data being MCAR, MAR, or MNAR?\n\n::: callout\n-   **MAR: Missing at Random**\n:::\n\n(d) Carry out Little's statistical test to evaluate MCAR and report results.\n\n::: callout\n **P-value < 0.05: Rejects the MCAR hypothesis; data may be MAR or NMAR.**\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmcar_test(data) |> \n  DT::datatable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-1a9c73c758f3d42f43ba\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-1a9c73c758f3d42f43ba\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\"],[35.10612886897025],[14],[0.001417781138566832],[4]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>statistic<\\/th>\\n      <th>df<\\/th>\\n      <th>p.value<\\/th>\\n      <th>missing.patterns<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"statistic\",\"targets\":1},{\"name\":\"df\",\"targets\":2},{\"name\":\"p.value\",\"targets\":3},{\"name\":\"missing.patterns\",\"targets\":4}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n(e) Creating a binary indicator for missingness allows you to test whether the presence of missing data is related to observed data.\n\n    -   For instance, you can create a dummy variable: 1 = Missing; 0 = Observed.\n    -   Next you can conduct a chi-square test or t-test:\n        -   Chi-square: Compare proportions of missingness ***across groups***.\n        -   T-test: Compare means of (other) observed variables with missingness indicators.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata = data |> \n  mutate(Ozone_missing = ifelse(is.na(Ozone), 1, 0)) |> \n  group_by(Ozone_missing) \n\ndata |> \n  head() |>\n  DT::datatable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-80bdcc3a4a739110282a\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-80bdcc3a4a739110282a\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\"],[41,36,12,18,null,28],[190,118,149,313,null,null],[7.4,8,12.6,11.5,14.3,14.9],[67,72,74,62,56,66],[5,5,5,5,5,5],[1,2,3,4,5,6],[0,0,0,0,1,0]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Ozone<\\/th>\\n      <th>Solar.R<\\/th>\\n      <th>Wind<\\/th>\\n      <th>Temp<\\/th>\\n      <th>Month<\\/th>\\n      <th>Day<\\/th>\\n      <th>Ozone_missing<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5,6,7]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"Ozone\",\"targets\":1},{\"name\":\"Solar.R\",\"targets\":2},{\"name\":\"Wind\",\"targets\":3},{\"name\":\"Temp\",\"targets\":4},{\"name\":\"Month\",\"targets\":5},{\"name\":\"Day\",\"targets\":6},{\"name\":\"Ozone_missing\",\"targets\":7}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(purrr)\nlibrary(broom)\n\n# Specify which variables to compare\nvars_to_test <- c(\"Solar.R\", \"Wind\", \"Temp\")\n\n# Build a summary tibble with group means and t-test results\nt_summary <- map_dfr(vars_to_test, function(v) {\n  # 1) Compute the mean of variable 'v' by Ozone_missing\n  means <- data |> \n    group_by(Ozone_missing)|>\n    summarise(mean_val = mean(.data[[v]], na.rm = TRUE), .groups = \"drop\")\n  mean0 <- means$mean_val[means$Ozone_missing == 0]\n  mean1 <- means$mean_val[means$Ozone_missing == 1]\n\n  # 2) Run a Welch two‐sample t-test comparing groups\n  tt <- t.test(as.formula(paste(v, \"~ Ozone_missing\")), data = data, na.action = na.omit)\n  tt_tidy <- broom::tidy(tt)\n\n  # 3) Return one row with all results\n  tibble(\n    variable      = v,\n    mean_obs      = mean0,\n    mean_missing  = mean1,\n    mean_diff     = mean1 - mean0,\n    t_statistic   = tt_tidy$statistic,\n    df            = tt_tidy$parameter,\n    p_value       = tt_tidy$p.value,\n    conf_low      = tt_tidy$conf.low,\n    conf_high     = tt_tidy$conf.high\n  )\n})\n\n# View the organized results\nt_summary |> \n  DT::datatable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-7c5290bd591dd45f08d4\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7c5290bd591dd45f08d4\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\"],[\"Solar.R\",\"Wind\",\"Temp\"],[184.8018018018018,9.862068965517242,77.87068965517241],[189.5142857142857,10.25675675675676,77.91891891891892],[4.71248391248389,0.3946877912395141,0.04822926374650649],[-0.2745676315193852,-0.6091058880570918,-0.02683064282817306],[58.99513515577019,63.64595199312921,60.44704943982977],[0.7846076487298359,0.5446224106020163,0.9786831966970868],[-39.05620733592335,-1.689313244904939,-3.643305949045689],[29.63123951095557,0.8999376624259103,3.546847421552676]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>variable<\\/th>\\n      <th>mean_obs<\\/th>\\n      <th>mean_missing<\\/th>\\n      <th>mean_diff<\\/th>\\n      <th>t_statistic<\\/th>\\n      <th>df<\\/th>\\n      <th>p_value<\\/th>\\n      <th>conf_low<\\/th>\\n      <th>conf_high<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3,4,5,6,7,8,9]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"variable\",\"targets\":1},{\"name\":\"mean_obs\",\"targets\":2},{\"name\":\"mean_missing\",\"targets\":3},{\"name\":\"mean_diff\",\"targets\":4},{\"name\":\"t_statistic\",\"targets\":5},{\"name\":\"df\",\"targets\":6},{\"name\":\"p_value\",\"targets\":7},{\"name\":\"conf_low\",\"targets\":8},{\"name\":\"conf_high\",\"targets\":9}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n#### Question 2:\n\nCreate **new and appropriately named datasets** that are based on airquality for each of the following ways of fixing the dataset:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1) Original data\norig_data <- data|>\n  dplyr::select(Ozone)|>\n  mutate(method = \"Original\")\n\n# 2) Listwise deletion\nlistwise_data <- data|>\n  drop_na(Ozone)|>\n dplyr::select(Ozone)|>\n  mutate(method = \"Listwise Deletion\")\n\n# 3) Mean imputation\nmean_imp_data <- data|>\n  mutate(Ozone = ifelse(is.na(Ozone), mean(Ozone, na.rm = TRUE), Ozone))|>\n dplyr:: select(Ozone)|>\n  mutate(method = \"Mean Imputation\")\n\n# 4) Regression imputation (deterministic)\nmethods_reg <- make.method(data)\nmethods_reg[c(\"Ozone\",\"Solar.R\",\"Wind\",\"Temp\")] <- \"norm.predict\"\npred_reg <- make.predictorMatrix(data)\npred_reg[,    \"Ozone_missing\"] <- 0\npred_reg[\"Ozone_missing\", ]   <- 0\nimp_reg <- mice(data,\n                method          = methods_reg,\n                predictorMatrix = pred_reg,\n                m               = 1,\n                maxit           = 10,\n                seed            = 123,\n                printFlag       = FALSE)\nreg_data <- complete(imp_reg, 1)|>\n dplyr::select(Ozone)|>\n  mutate(method = \"Regression Imputation\")\n\n# 5) Stochastic regression imputation\nmethods_stoch <- make.method(data)\nmethods_stoch[c(\"Ozone\",\"Solar.R\",\"Wind\",\"Temp\")] <- \"norm\"\npred_stoch <- make.predictorMatrix(data)\npred_stoch[,    \"Ozone_missing\"] <- 0\npred_stoch[\"Ozone_missing\", ]   <- 0\nimp_stoch <- mice(data,\n                  method          = methods_stoch,\n                  predictorMatrix = pred_stoch,\n                  m               = 1,\n                  maxit           = 10,\n                  seed            = 123,\n                  printFlag       = FALSE)\nstoch_data <- complete(imp_stoch, 1)|>\n  dplyr::select(Ozone)|>\n  mutate(method = \"Stochastic Regression\")\n\n# 6) Multiple imputation via predictive mean matching\nimp_pmm <- mice(data[, c(\"Ozone\",\"Solar.R\",\"Wind\",\"Temp\",\"Month\",\"Day\")],\n                method    = \"pmm\",\n                m         = 5,\n                seed      = 42,\n                printFlag = FALSE)\npmm_data <- complete(imp_pmm, 1)|>\n dplyr::select(Ozone)|>\n  mutate(method = \"PMM Imputation\")\n\n# 7) Combine all datasets\nplot_data <- bind_rows(\n  orig_data,\n  listwise_data,\n  mean_imp_data,\n  reg_data,\n  stoch_data,\n  pmm_data\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 8) Plot density overlays\nggplot(plot_data, aes(x = Ozone, color = method, fill = method)) +\n  geom_density(alpha = 0.4, adjust = 1) +\n  labs(\n    title = \"Density of Ozone: Original vs. Imputation Methods\",\n    x     = \"Ozone\",\n    y     = \"Density\"\n  ) +\n  scale_color_manual(values = palette) +\n  scale_fill_manual(values = palette) +\n  plot_aes\n```\n\n::: {.cell-output-display}\n![](Missing_data_lab/fig_unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n \nWhat do you observe?\n\n::: callout\nThe density plots show how the different imputation methods affect the distribution of the Ozone variable slightly.\n:::\n\n#### Of course, each dataset you produced will lead to different modeling results, but we won't go into that in today's lab.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}